{% extends "base.html" %}

{% block title %}Stok Listesi{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5><i class="bi bi-boxes"></i> Stok Listesi</h5>
                    {% if secili_depo %}
                        <small class="text-muted">Depo: <strong>{{ secili_depo.depo_adi }}</strong></small>
                    {% endif %}
                </div>
                <div class="d-flex gap-2">
                    {% if depo_istatistik %}
                    <div class="d-flex gap-1 me-3">
                        <span class="badge bg-primary">{{ depo_istatistik.toplam_urun }} Ürün</span>
                        <span class="badge bg-success">{{ depo_istatistik.stokta_olan }} Stokta</span>
                        <span class="badge bg-danger">{{ depo_istatistik.stokta_olmayan }} Boş</span>
                        <span class="badge bg-info">{{ depo_istatistik.toplam_stok_adedi }} Toplam</span>
                    </div>
                    {% endif %}
                    <select class="form-select" id="depoSelect" onchange="depoChanged()">
                        {% for depo in depolar %}
                            <option value="{{ depo.id }}" {{ 'selected' if depo.id == secili_depo_id else '' }}>
                                {{ depo.depo_adi }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Ürün Adı</th>
                                <th>Jant Ebatı</th>
                                <th>Desi (kg)</th>
                                <th>Barkod</th>
                                <th>Bu Depoda</th>
                                <th>Toplam Stok</th>
                                <th>Depo Dağılımı</th>
                                <th>Durum</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stok in stoklar %}
                            {% set toplam_stok_obj = toplam_stoklar | selectattr('id', 'equalto', stok.id) | first %}
                            <tr>
                                <td>{{ stok.id }}</td>
                                <td>{{ stok.urun_adi }}</td>
                                <td>
                                    <span class="badge bg-info">{{ stok.jant_ebati }}"</span>
                                </td>
                                <td>
                                    <span class="badge bg-warning text-dark">{{ "%.2f"|format(stok.desi or 0) }} kg</span>
                                </td>
                                <td>
                                    <code>{{ stok.barkod or 'N/A' }}</code>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if stok.stok_adedi and stok.stok_adedi > 10 else 'warning' if stok.stok_adedi and stok.stok_adedi > 0 else 'danger' }}">
                                        {{ stok.stok_adedi or 0 }}
                                    </span>
                                </td>
                                <td>
                                    {% if toplam_stok_obj %}
                                        <span class="badge bg-{{ 'success' if toplam_stok_obj.toplam_stok > 20 else 'warning' if toplam_stok_obj.toplam_stok > 0 else 'danger' }}">
                                            {{ toplam_stok_obj.toplam_stok or 0 }}
                                        </span>
                                        <small class="text-muted">({{ toplam_stok_obj.depo_sayisi }} depoda)</small>
                                    {% else %}
                                        <span class="badge bg-danger">0</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if toplam_stok_obj and toplam_stok_obj.depo_detay %}
                                        <button type="button" class="btn btn-sm btn-outline-info" 
                                                data-bs-toggle="popover" 
                                                data-bs-placement="left"
                                                data-bs-content="{{ toplam_stok_obj.depo_detay }}"
                                                title="Depo Dağılımı">
                                            <i class="bi bi-info-circle"></i>
                                        </button>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if not stok.stok_adedi or stok.stok_adedi == 0 %}
                                        <span class="badge bg-danger">Bu Depoda Yok</span>
                                    {% elif stok.stok_adedi <= 5 %}
                                        <span class="badge bg-warning">Kritik Seviye</span>
                                    {% elif stok.stok_adedi <= 10 %}
                                        <span class="badge bg-info">Düşük Stok</span>
                                    {% else %}
                                        <span class="badge bg-success">Yeterli</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{{ url_for('urun_guncelle', id=stok.id) }}" 
                                           class="btn btn-outline-primary" 
                                           title="Ürünü Düzenle">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <button type="button" 
                                                class="btn btn-outline-success hizli-stok-btn" 
                                                title="Hızlı Stok Düzenle"
                                                data-urun-id="{{ stok.id }}"
                                                data-urun-adi="{{ stok.urun_adi }}"
                                                data-mevcut-stok="{{ stok.stok_adedi or 0 }}">
                                            <i class="bi bi-box"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {% if not stoklar %}
                <div class="text-center py-4">
                    <i class="bi bi-box text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3">Bu depoda hiç stok bulunamadı.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-3">
        <div class="card border-success">
            <div class="card-body text-center">
                <h5 class="text-success">Yeterli Stok</h5>
                <h3 class="text-success">
                    {% set yeterli_count = 0 %}
                    {% for stok in stoklar %}
                        {% if stok.stok_adedi and stok.stok_adedi > 10 %}
                            {% set yeterli_count = yeterli_count + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ yeterli_count }}
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-warning">
            <div class="card-body text-center">
                <h5 class="text-warning">Düşük Stok</h5>
                <h3 class="text-warning">
                    {% set dusuk_count = 0 %}
                    {% for stok in stoklar %}
                        {% if stok.stok_adedi and stok.stok_adedi <= 10 and stok.stok_adedi > 0 %}
                            {% set dusuk_count = dusuk_count + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ dusuk_count }}
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-danger">
            <div class="card-body text-center">
                <h5 class="text-danger">Stokta Yok</h5>
                <h3 class="text-danger">
                    {% set yok_count = 0 %}
                    {% for stok in stoklar %}
                        {% if not stok.stok_adedi or stok.stok_adedi == 0 %}
                            {% set yok_count = yok_count + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ yok_count }}
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-info">
            <div class="card-body text-center">
                <h5 class="text-info">Toplam Ürün</h5>
                <h3 class="text-info">{{ stoklar | length }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Hızlı Stok Düzenleme Modal -->
<div class="modal fade" id="hizliStokModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-box"></i> Hızlı Stok Düzenleme
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="hizliStokForm">
                    <input type="hidden" id="hizli_urun_id">
                    <input type="hidden" id="hizli_depo_id" value="{{ secili_depo_id }}">
                    
                    <div class="mb-3">
                        <label class="form-label">Ürün</label>
                        <input type="text" class="form-control" id="hizli_urun_adi" readonly>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Mevcut Stok</label>
                            <input type="text" class="form-control" id="hizli_mevcut_stok" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Yeni Stok Miktarı <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="hizli_yeni_stok" min="0" required>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">Açıklama</label>
                        <textarea class="form-control" id="hizli_aciklama" rows="2" placeholder="Stok güncelleme sebebi..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-success" onclick="hizliStokKaydet()">
                    <i class="bi bi-check-lg"></i> Stoğu Güncelle
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function depoChanged() {
    const depoId = document.getElementById('depoSelect').value;
    window.location.href = '{{ url_for("stok_listesi") }}?depo_id=' + depoId;
}

// Hızlı stok düzenleme modal'ını aç
document.addEventListener('DOMContentLoaded', function() {
    // Popover'ları etkinleştir
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl);
    });
    
    // Hızlı stok düzenleme butonları
    document.querySelectorAll('.hizli-stok-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const urunId = this.getAttribute('data-urun-id');
            const urunAdi = this.getAttribute('data-urun-adi');
            const mevcutStok = this.getAttribute('data-mevcut-stok');
            
            document.getElementById('hizli_urun_id').value = urunId;
            document.getElementById('hizli_urun_adi').value = urunAdi;
            document.getElementById('hizli_mevcut_stok').value = mevcutStok;
            document.getElementById('hizli_yeni_stok').value = mevcutStok;
            document.getElementById('hizli_aciklama').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('hizliStokModal'));
            modal.show();
        });
    });
});

function hizliStokKaydet() {
    const urunId = document.getElementById('hizli_urun_id').value;
    const depoId = document.getElementById('hizli_depo_id').value;
    const mevcutStok = parseInt(document.getElementById('hizli_mevcut_stok').value);
    const yeniStok = parseInt(document.getElementById('hizli_yeni_stok').value);
    const aciklama = document.getElementById('hizli_aciklama').value;
    
    if (isNaN(yeniStok) || yeniStok < 0) {
        alert('Lütfen geçerli bir stok miktarı giriniz!');
        return;
    }
    
    // Stok farkını hesapla
    const fark = yeniStok - mevcutStok;
    let apiEndpoint, data;
    
    if (fark > 0) {
        // Stok girişi
        apiEndpoint = '/api/stok_giris';
        data = {
            depo_id: parseInt(depoId),
            urun_id: parseInt(urunId),
            miktar: fark,
            aciklama: aciklama || 'Hızlı stok düzenleme (giriş)'
        };
    } else if (fark < 0) {
        // Stok çıkışı
        apiEndpoint = '/api/stok_cikis';
        data = {
            depo_id: parseInt(depoId),
            urunler: [{
                urun_id: parseInt(urunId),
                adet: Math.abs(fark)
            }],
            aciklama: aciklama || 'Hızlı stok düzenleme (çıkış)'
        };
    } else {
        alert('Stok miktarı değişmedi!');
        return;
    }
    
    // API çağrısı
    fetch(apiEndpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Stok başarıyla güncellendi!');
            location.reload();
        } else {
            alert('Hata: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('İşlem sırasında hata oluştu!');
    });
}
</script>
{% endblock %}