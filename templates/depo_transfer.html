{% extends "base.html" %}

{% block title %}Depo Transfer{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-md-10 mx-auto">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-arrow-left-right"></i> Depo Arası Transfer</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="transferForm">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="kaynak_depo_id" class="form-label">
                                    <i class="bi bi-building"></i> Kaynak Depo
                                </label>
                                <select class="form-select" id="kaynak_depo_id" name="kaynak_depo_id" required>
                                    <option value="">Kaynak depo seçiniz...</option>
                                    {% for depo in depolar %}
                                        <option value="{{ depo.id }}">{{ depo.depo_adi }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="hedef_depo_id" class="form-label">
                                    <i class="bi bi-building-fill"></i> Hedef Depo
                                </label>
                                <select class="form-select" id="hedef_depo_id" name="hedef_depo_id" required>
                                    <option value="">Hedef depo seçiniz...</option>
                                    {% for depo in depolar %}
                                        <option value="{{ depo.id }}">{{ depo.depo_adi }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="transfer_adedi" class="form-label">
                                    <i class="bi bi-123"></i> Transfer Adedi
                                </label>
                                <input type="number" class="form-control" id="transfer_adedi" name="transfer_adedi" 
                                       min="1" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="urun_arama" class="form-label">
                            <i class="bi bi-search"></i> Ürün Arama (İsim veya Barkod)
                        </label>
                        <div class="search-container">
                            <input type="text" class="form-control" id="urun_arama" 
                                   placeholder="Transfer edilecek ürünü arayın...">
                            <div class="search-results" id="searchResults"></div>
                        </div>
                        <input type="hidden" id="urun_id" name="urun_id" required>
                        <div class="mt-2">
                            <small class="text-muted">Seçili ürün: <span id="secili_urun" class="fw-bold">Henüz seçilmedi</span></small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="aciklama" class="form-label">
                            <i class="bi bi-chat-text"></i> Transfer Açıklaması
                        </label>
                        <textarea class="form-control" id="aciklama" name="aciklama" rows="3" 
                                  placeholder="Transfer sebebi veya notlar..."></textarea>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Dikkat:</strong> Transfer işlemi kaynak depodan stok düşürüp hedef depoya ekleyecektir. 
                        Kaynak depoda yeterli stok olduğundan emin olun.
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-secondary" onclick="formTemizle()">
                            <i class="bi bi-arrow-clockwise"></i> Temizle
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-arrow-left-right"></i> Transfer Yap
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6><i class="bi bi-info-circle"></i> Transfer İşlemi Hakkında</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>Ne zaman kullanılır:</h6>
                        <ul>
                            <li>Depo dengeleme</li>
                            <li>Stok dağıtımı</li>
                            <li>Merkezi dağıtım</li>
                            <li>Acil stok aktarımı</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6>Transfer Süreci:</h6>
                        <ol>
                            <li>Kaynak depodan stok düşülür</li>
                            <li>Hedef depoya stok eklenir</li>
                            <li>İşlem geçmişine kaydedilir</li>
                            <li>Kullanıcı bilgileri loglanır</li>
                        </ol>
                    </div>
                    <div class="col-md-4">
                        <h6>Önemli Uyarılar:</h6>
                        <ul>
                            <li>Kaynak ve hedef depo farklı olmalı</li>
                            <li>Kaynak depoda yeterli stok olmalı</li>
                            <li>Transfer adedi pozitif olmalı</li>
                            <li>İşlem geri alınamaz</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let searchTimeout;

document.getElementById('urun_arama').addEventListener('input', function() {
    const query = this.value;
    const resultsDiv = document.getElementById('searchResults');
    
    if (query.length < 2) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        fetch(`/api/urun_ara?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                resultsDiv.innerHTML = '';
                
                if (data.length === 0) {
                    resultsDiv.innerHTML = '<div class="search-result-item">Ürün bulunamadı</div>';
                    resultsDiv.style.display = 'block';
                    return;
                }
                
                data.forEach(urun => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.innerHTML = `
                        <div class="fw-bold">${urun.urun_adi}</div>
                        <small class="text-muted">
                            Barkod: ${urun.barkod || 'N/A'} | 
                            Jant: ${urun.jant_ebati}"
                        </small>
                    `;
                    item.addEventListener('click', () => {
                        selectUrun(urun);
                    });
                    resultsDiv.appendChild(item);
                });
                
                resultsDiv.style.display = 'block';
            })
            .catch(error => {
                console.error('Arama hatası:', error);
            });
    }, 300);
});

function selectUrun(urun) {
    document.getElementById('urun_id').value = urun.id;
    document.getElementById('urun_arama').value = urun.urun_adi;
    document.getElementById('secili_urun').textContent = 
        `${urun.urun_adi} (${urun.barkod || 'N/A'})`;
    document.getElementById('searchResults').style.display = 'none';
}

function formTemizle() {
    document.getElementById('transferForm').reset();
    document.getElementById('urun_id').value = '';
    document.getElementById('secili_urun').textContent = 'Henüz seçilmedi';
    document.getElementById('searchResults').style.display = 'none';
}

// Kaynak ve hedef depo aynı olmasın
document.getElementById('kaynak_depo_id').addEventListener('change', function() {
    const kaynakDepo = this.value;
    const hedefSelect = document.getElementById('hedef_depo_id');
    
    Array.from(hedefSelect.options).forEach(option => {
        if (option.value === kaynakDepo) {
            option.disabled = true;
        } else {
            option.disabled = false;
        }
    });
    
    if (hedefSelect.value === kaynakDepo) {
        hedefSelect.value = '';
    }
});

document.getElementById('hedef_depo_id').addEventListener('change', function() {
    const hedefDepo = this.value;
    const kaynakSelect = document.getElementById('kaynak_depo_id');
    
    Array.from(kaynakSelect.options).forEach(option => {
        if (option.value === hedefDepo) {
            option.disabled = true;
        } else {
            option.disabled = false;
        }
    });
    
    if (kaynakSelect.value === hedefDepo) {
        kaynakSelect.value = '';
    }
});

// Sayfa dışında tıklandığında arama sonuçlarını gizle
document.addEventListener('click', function(event) {
    const searchContainer = document.querySelector('.search-container');
    if (!searchContainer.contains(event.target)) {
        document.getElementById('searchResults').style.display = 'none';
    }
});
</script>
{% endblock %}